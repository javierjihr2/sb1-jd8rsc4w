"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[696],{22424:(e,t,r)=>{r.d(t,{Ds:()=>p,Hv:()=>f,Jv:()=>l,Ss:()=>d,bA:()=>u,hR:()=>g,mT:()=>y,ul:()=>m});var n=r(56104),a=r(35317),i=r(6033),o=r(68598);async function s(e){try{let t=(0,o.Ip)(e);if(!t.isValid)return{success:!1,error:t.errors.join(", ")};let r={...e,createdAt:new Date,expiresAt:e.expiresAt||new Date(Date.now()+6048e5)},i=await (0,a.gS)((0,a.rJ)(n.db,"notifications"),r),s=(0,a.P)((0,a.rJ)(n.db,"notificationSubscriptions"),(0,a._M)("userId","==",e.userId),(0,a._M)("active","==",!0)),d=(await (0,a.GG)(s)).docs.map(async e=>{let t=e.data();try{await c(t,r)}catch(t){console.error("Error sending to device:",t),await (0,a.mZ)((0,a.H9)(n.db,"notificationSubscriptions",e.id),{active:!1})}});return await Promise.allSettled(d),{success:!0,notificationId:i.id}}catch(r){console.error("Error sending push notification:",r);let t=i.$2.messageSend(e.userId,{operation:"sendPushNotification",notification:e},"high"===e.priority?"high":"medium");return{success:!1,error:r instanceof Error?r.message:"Unknown error",retryId:t}}}async function c(e,t){console.log("Sending notification to device:",{endpoint:e.endpoint,notification:{title:t.title,body:t.body,data:t.data}}),await new Promise(e=>setTimeout(e,100))}async function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{let i=(0,a.P)((0,a.rJ)(n.db,"notifications"),(0,a._M)("userId","==",e),(0,a.My)("createdAt","desc"),(0,a.AB)(t));r&&(i=(0,a.P)((0,a.rJ)(n.db,"notifications"),(0,a._M)("userId","==",e),(0,a._M)("read","==",!1),(0,a.My)("createdAt","desc"),(0,a.AB)(t)));let o=(await (0,a.GG)(i)).docs.map(e=>({id:e.id,...e.data()}));return{success:!0,notifications:o}}catch(e){return console.error("Error getting user notifications:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function u(e){try{return await (0,a.mZ)((0,a.H9)(n.db,"notifications",e),{read:!0}),{success:!0}}catch(r){console.error("Error marking notification as read:",r);let t=i.$2.messageSend("system",{operation:"markNotificationAsRead",notificationId:e},"low");return{success:!1,error:r instanceof Error?r.message:"Unknown error",retryId:t}}}function l(e,t){let r=(0,a.P)((0,a.rJ)(n.db,"notifications"),(0,a._M)("userId","==",e),(0,a.My)("createdAt","desc"),(0,a.AB)(50));return(0,a.aQ)(r,e=>{t(e.docs.map(e=>({id:e.id,...e.data()})))})}async function m(e){try{let t=(0,a.P)((0,a.rJ)(n.db,"notifications"),(0,a._M)("userId","==",e),(0,a._M)("read","==",!1)),r=await (0,a.GG)(t);return{success:!0,count:r.size}}catch(e){return console.error("Error getting unread notification count:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function f(e,t,r,n){return s({userId:e,type:"message",title:"Nuevo mensaje de ".concat(t),body:r,data:{chatId:n,type:"message"},read:!1,priority:"high",actionUrl:"/chats/".concat(n)})}async function g(e,t,r){return s({userId:e,type:"friend_request",title:"Nueva solicitud de amistad",body:"".concat(t," te ha enviado una solicitud de amistad"),data:{senderId:r,type:"friend_request"},read:!1,priority:"normal",actionUrl:"/friends"})}async function p(e,t,r,n){try{let a,i,o="normal";switch(r){case"registered":a="Registro confirmado",i="Te has registrado exitosamente en ".concat(t);break;case"waitlisted":a="En lista de espera",i="Has sido agregado a la lista de espera de ".concat(t);break;case"moved-from-waitlist":a="\xa1Registro confirmado!",i="Has sido movido de la lista de espera a participante activo en ".concat(t),o="high";break;case"tournament-starting":a="Torneo iniciando",i="".concat(t," est\xe1 a punto de comenzar"),o="high";break;case"tournament-cancelled":a="Torneo cancelado",i="".concat(t," ha sido cancelado"),o="high";break;default:a="Actualizaci\xf3n de torneo",i="Hay una actualizaci\xf3n sobre ".concat(t)}return await s({userId:e,type:"tournament_invite",title:a,body:i,priority:o,read:!1,actionUrl:"/tournaments/".concat(n),data:{tournamentId:n,tournamentTitle:t,notificationType:r,type:"tournament"}})}catch(e){return console.error("Error sending tournament notification:",e),{success:!1,error:"Failed to send tournament notification"}}}async function y(){try{if(!("Notification"in window))return{success:!1,error:"Este navegador no soporta notificaciones"};if("granted"===Notification.permission)return{success:!0,permission:"granted"};let e=await Notification.requestPermission();return{success:"granted"===e,permission:e,error:"denied"===e?"Permisos de notificaci\xf3n denegados":void 0}}catch(e){return console.error("Error requesting notification permission:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}},90696:(e,t,r)=>{r.d(t,{registerForTournament:()=>c});var n=r(35317),a=r(56104),i=r(6033),o=r(68598),s=r(22424);async function c(e,t,r,c,u){try{let i=(0,o.Ri)({tournamentId:e,userId:t,username:r,teamName:c||"",teamMembers:u||[]});if(!i.isValid)return{success:!1,error:i.errors.join(", ")};let l=await (0,n.x7)((0,n.H9)(a.db,"tournaments",e));if(!l.exists())return{success:!1,error:"Tournament not found"};let m=l.data();if("registration-open"!==m.status)return{success:!1,error:"Registration is not open for this tournament"};let f=m.registrationDeadline instanceof Date?m.registrationDeadline:m.registrationDeadline.toDate();if(new Date>f)return{success:!1,error:"Registration deadline has passed"};if(await d(e,t))return{success:!1,error:"Already registered for this tournament"};let g=m.currentParticipants>=m.maxParticipants,p=g?"waitlisted":"registered",y={tournamentId:e,userId:t,username:r,teamName:c,teamMembers:u,registrationDate:new Date,status:p,paymentStatus:m.entryFee>0?"pending":"paid"};await (0,n.gS)((0,n.rJ)(a.db,"tournamentRegistrations"),{...y,registrationDate:(0,n.O5)()});let h={updatedAt:(0,n.O5)()};g?h.waitlist=(0,n.hq)(t):(h.participants=(0,n.hq)(t),h.currentParticipants=(0,n.GV)(1)),await (0,n.mZ)((0,n.H9)(a.db,"tournaments",e),h);try{await (0,s.Ds)(t,m.title,g?"waitlisted":"registered",e)}catch(e){console.error("Error sending tournament notification:",e)}return{success:!0,status:p}}catch(n){return console.error("Error registering for tournament:",n),i.$2.tournamentRegister(t,{tournamentId:e,username:r,teamName:c,teamMembers:u},"medium"),{success:!1,error:"Failed to register for tournament"}}}async function d(e,t){try{let i=(0,n.P)((0,n.rJ)(a.db,"tournamentRegistrations"),(0,n._M)("tournamentId","==",e),(0,n._M)("userId","==",t)),o=await (0,n.GG)(i);if(!o.empty){var r;let e=o.docs[0],t=e.data();return{id:e.id,...t,registrationDate:(null==(r=t.registrationDate)?void 0:r.toDate())||new Date}}return null}catch(e){return console.error("Error getting user tournament registration:",e),null}}}}]);